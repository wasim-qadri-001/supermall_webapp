<!-- public/offer.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Manage Offers - Super Mall</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./assets/css/style.css" />
    <style>
      .back-link {
        display: inline-block;
        margin-bottom: 1rem;
        text-decoration: none;
        color: #007bff;
        font-weight: bold;
      }
      .back-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Manage Offers</h2>
      <a href="admin.html" class="back-link">â¬… Back to Dashboard</a>

      <section>
        <h3>Add Offer</h3>
        <form id="offerForm">
          <input type="text" id="shopId" placeholder="Shop ID" required />
          <input
            type="text"
            id="offerTitle"
            placeholder="Offer Title"
            required
          />
          <input type="text" id="discount" placeholder="Discount %" required />
          <input
            type="date"
            id="expiryDate"
            placeholder="Expiry Date"
            required
          />
          <button type="submit">Add Offer</button>
        </form>
      </section>

      <hr />

      <section>
        <h3>Existing Offers</h3>
        <ul id="offerList"></ul>
      </section>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyA0LcTrTGPzDjR4WI4iIKjhxXcC8ugfGW8",
        authDomain: "supermall-webapp-12ad5.firebaseapp.com",
        projectId: "supermall-webapp-12ad5",
        storageBucket: "supermall-webapp-12ad5.firebasestorage.app",
        messagingSenderId: "281411344748",
        appId: "1:281411344748:web:ce23c84c710c7a58363b49",
        measurementId: "G-QLMN69T00C",
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
    </script>

    <!-- Offer Script -->
    <script>
      auth.onAuthStateChanged((user) => {
        if (!user) window.location.href = "login.html";
      });

      const offerForm = document.getElementById("offerForm");
      const offerList = document.getElementById("offerList");
      let editOfferId = null;

      offerForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const shopId = document.getElementById("shopId").value;
        const title = document.getElementById("offerTitle").value;
        const discount = document.getElementById("discount").value;
        const expiry = document.getElementById("expiryDate").value;

        if (editOfferId) {
          db.collection("offers")
            .doc(editOfferId)
            .update({
              shopId,
              title,
              discount,
              expiryDate: expiry,
            })
            .then(() => {
              alert("Offer updated!");
              offerForm.reset();
              editOfferId = null;
              document.getElementById("formTitle").textContent = "Add Offer";
              loadOffers();
            });
        } else {
          db.collection("offers")
            .add({
              shopId,
              title,
              discount,
              expiryDate: expiry,
              createdAt: new Date(),
            })
            .then(() => {
              alert("Offer added!");
              offerForm.reset();
              loadOffers();
            });
        }
      });

      function loadOffers() {
        offerList.innerHTML = "";
        db.collection("offers")
          .orderBy("createdAt", "desc")
          .get()
          .then((snapshot) => {
            snapshot.forEach((doc) => {
              const data = doc.data();
              const li = document.createElement("li");
              li.innerHTML = `
              <strong>${data.title}</strong> (Shop: ${data.shopId}) - ${data.discount}% off until ${data.expiryDate}
              <button onclick="editOffer('${doc.id}', '${data.shopId}', '${data.title}', '${data.discount}', '${data.expiryDate}')">Edit</button>
              <button onclick="deleteOffer('${doc.id}')">Delete</button>
            `;
              offerList.appendChild(li);
            });
          });
      }

      function deleteOffer(id) {
        if (confirm("Are you sure you want to delete this offer?")) {
          db.collection("offers")
            .doc(id)
            .delete()
            .then(() => {
              alert("Offer deleted");
              loadOffers();
            });
        }
      }

      function editOffer(id, shopId, title, discount, expiryDate) {
        document.getElementById("shopId").value = shopId;
        document.getElementById("offerTitle").value = title;
        document.getElementById("discount").value = discount;
        document.getElementById("expiryDate").value = expiryDate;
        document.getElementById("formTitle").textContent = "Edit Offer";
        editOfferId = id;
      }

      window.onload = loadOffers;
    </script>
  </body>
</html>
